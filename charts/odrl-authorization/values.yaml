# -- String to fully override common.names.fullname
fullnameOverride: ''
# -- String to fully override common.names.namespace
nameOverride: ''
apisix:
  #-- Enable apisix deployment. See [chart documentation](https://artifacthub.io/packages/helm/apisix/apisix) for more details
  enabled: true
  ingress-controller:
    # -- Enable the ingress controller pod to read Kubernetes Ingress resources. See [chart documentation](https://artifacthub.io/packages/helm/apisix/apisix-ingress-controller) for more details
    enabled: true
    gatewayProxy:
      # -- Controls whether to create a default GatewayProxy custom resource.
      createDefault: true
    config:
      kubernetes:
        # -- Name of the ingress class created in kubernetes
        ingressClass: apisix
        # -- Set apisix ingress as default ingress in kubernetes
        defaultIngressClass: false
  apisix:
    deployment:
      mode: traditional
    admin:
      enabled: true
    customPlugins:
      enabled: true
      plugins:
        - name: "opa-lua"
          configMap:
            name: opa-lua
            # The plugin file must be located under the /{custom_path}/apisix/plugins directory.
            # Reference: https://apisix.apache.org/docs/apisix/plugin-develop/#where-to-put-your-plugins
            mounts:
              - key: opa.lua
                path: /opts/custom_plugins/apisix/plugins/opa.lua
              - key: helper.lua
                path:  /opts/custom_plugins/apisix/plugins/helper.lua
  extraContainers:
    # -- Deploy Open-Policy-Agent as sidecar
    - name: open-policy-agent
      image: openpolicyagent/opa:1.11.0
      imagePullPolicy: IfNotPresent
      ports:
        - name: opa-http
          containerPort: 8181
          protocol: TCP
      args:
        - "run"
        - "--ignore=.*"  # exclude hidden dirs created by Kubernetes
        - "--server"
        - "-l"
        - "debug"
        - "-c"
        - "/config/opa.yaml"
        - "--addr"
        - "0.0.0.0:8181"
        - "/tpp/tpp.rego"
      volumeMounts:
        - name: opa-config
          mountPath: /config
        - name: tpp-policy
          mountPath: /tpp
  extraVolumes:
    - name: tpp-policy
      configMap:
        name: tpp-policy
    - name: opa-config
      configMap:
        name: opa-config
  # -- configuration of a catchAll-route(e.g. /*)
  catchAllRoute:
    # -- enable catch all route
    enabled: true
    # -- configuration to connect the upstream broker
    upstream:
      url: http://my-broker:8080
      # -- Domain or Service
      type: Service
    # -- configuration to verify the jwt, coming from the verifier
    oidc:
      clientId: mySecuredService
      discoveryEndpoint: http://verifier:3000/services/mySecuredService/.well-known/openid-configuration
    opa:
      host: 'http://localhost:8181'
      policy: policy/main
      with_body: true
  # -- configuration of routes for apisix. E.g.
  # uri: /*
  #   host: host-name-test
  #   type: Service
  #   namespace: super-ns # release namespace by default
  #   upstream:
  #     nodes:
  #       data-service-test:9090: 1
  #     type: roundrobin
  #   plugins:
  #     openid-connect:
  #       bearer_only: true
  #       use_jwks: true
  #       client_id: data-service
  #       client_secret: unused
  #       discovery: https://verifier:8080/services/data-service/.well-known/openid-configuration
  #     opa:
  #       host: "http://localhost:8181"
  #       policy: policy/main
  #       with_body: true
  routes: []
  etcd:
    enabled: true

opa:
  # -- config forÂ open policy agent. Deployed as a PDP
  config:
    # -- address of the odrl-pap to get the policies from
    resourceUrl: http://odrl-pap:8080/bundles/service/v1
    # -- port to make opa available at
    port: 8181
    # -- pull delays for the policies bundle (in seconds)
    policies:
      minDelay: 2
      maxDelay: 4
    # -- pull delays for the methods bundle
    methods:
      minDelay: 1
      maxDelay: 3
    # -- pull delays for the data bundle
    data:
      minDelay: 1
      maxDelay: 15
# -- integration of checks for the transfer process protocol
tpp:
  # -- should checking for a running transfer process be enabled
  enabled: false
  transfers:
    # -- host of the endpoint to check the process id, e.g. rainbow
    host: ""
    # -- path to check the id at
    path: /transfers

odrl-pap:
  # -- Enable the deployment of odr-pap. OPA requires it; if disabled, you will need to deploy it manually.
  enabled: true
  # -- allows to set a fixed name for the services
  fullnameOverride: odrl-pap
  # -- connection to the database
  database:
    # -- url to connect the db at
    url: jdbc:postgresql://postgresql:5432/pap
    # -- username to access the db
    username: postgres
    # -- secret to take the password from
    existingSecret:
      enabled: true
      name: database-secret
      key: postgres-admin-password
